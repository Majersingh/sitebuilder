version: 2.1

# Enable pipeline parameters
parameters:
  user_id:
    type: string
    default: "none"

orbs:
  node: circleci/node@5.1.0

jobs:
  build_and_deploy:
    docker:
      - image: cimg/node:18.19

    environment:
      NEXT_TELEMETRY_DISABLED: true

    steps:
      - checkout

      # Install dependencies
      - run:
          name: Install Dependencies
          command: npm install

      # Fetch user config using pipeline parameter
      - run:
          name: Fetch siteConfig from Backend API
          command: |
            echo "ðŸš€ Building site for user: << pipeline.parameters.user_id >>"

            # Build API URL dynamically
            API_URL="$USER_CONFIG_API_URL?userId=<< pipeline.parameters.user_id >>"

            echo "Fetching config from: $API_URL"

            # Get config response
            curl -s "$API_URL" -o api_response.json

            echo "API Response:"
            cat api_response.json

            # Check success
            SUCCESS=$(jq -r '.success' api_response.json)

            if [ "$SUCCESS" != "true" ]; then
              echo "âŒ ERROR: Backend returned success=false"
              exit 1
            fi

            # Make sure config folder exists
            mkdir -p src/config

            # Extract .data (actual config) into siteConfig.json
            jq '.data' api_response.json > src/config/siteConfig.json

            echo "âœ” Extracted siteConfig:"
            cat src/config/siteConfig.json

      # Prepare Netlify build
      - run:
          name: Install Netlify CLI + Next Plugin
          command: |
            npm install -g netlify-cli
            npm install @netlify/plugin-nextjs

      # Build Next.js
      - run:
          name: Build Project
          command: npm run build

      # Deploy to Netlify
      - run:
          name: Deploy to Netlify
          command: |
            echo "ðŸš€ Deploying to Netlify..."

            netlify deploy \
              --auth=$NETLIFY_AUTH_TOKEN \
              --dir=.next \
              --build \
              --json > deploy_output.json

            echo "Deployment Output:"
            cat deploy_output.json

            SITE_ID=$(jq -r '.site_id' deploy_output.json)
            DEPLOY_URL=$(jq -r '.deploy_url' deploy_output.json)

            echo "âœ” New Site ID: $SITE_ID"
            echo "âœ” Live URL: $DEPLOY_URL"

            echo "$SITE_ID" > new_site_id.txt
            echo "$DEPLOY_URL" > new_deploy_url.txt

      # Send deployment info back to backend
      - run:
          name: Send deployment info to backend
          command: |
            echo "Posting deployment result back to backend..."

            curl -X POST "$BACKEND_UPDATE_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_AUTH_TOKEN" \
              -d "{\"userId\": \"<< pipeline.parameters.user_id >>\", \"siteId\": \"$(cat new_site_id.txt)\", \"url\": \"$(cat new_deploy_url.txt)\"}"

            echo "âœ” Deployment info saved."

      - store_artifacts:
          path: deploy_output.json
          destination: deploy_output

workflows:
  version: 2
  deploy_workflow:
    jobs:
      - build_and_deploy:
          user_id: << pipeline.parameters.user_id >>
