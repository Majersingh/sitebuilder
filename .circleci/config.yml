version: 2.1

# Pipeline default param
parameters:
  user_id:
    type: string
    default: "123"

orbs:
  node: circleci/node@5.1.0

jobs:
  build_and_deploy:

    parameters:
      user_id:
        type: string
        default: "123"

    docker:
      - image: cimg/node:22.8

    environment:
      NEXT_TELEMETRY_DISABLED: true

    steps:
      - checkout

      # Install dependencies
      - run:
          name: Install Dependencies
          command: npm install

      # Fetch siteConfig
      - run:
          name: Fetch siteConfig from Backend API
          command: |
            echo "ðŸš€ Building site for user: << parameters.user_id >>"

            API_URL="$USER_CONFIG_API_URL/<< parameters.user_id >>"
            echo "Fetching config from: $API_URL"

            curl -s "$API_URL" -o api_response.json

            cat api_response.json

            SUCCESS=$(jq -r '.success' api_response.json)
            [ "$SUCCESS" != "true" ] && echo "âŒ API error" && exit 1

            mkdir -p src/config
            jq '.data' api_response.json > src/config/siteConfig.json

      # Install Netlify CLI (local project install)
      - run:
          name: Install Netlify CLI + Next Plugin
          command: |
            npm install netlify-cli@latest
            npm install @netlify/plugin-nextjs

      # Build project
      - run:
          name: Build Next.js
          command: npm run build

      # Deploy using Netlify (NO prompts)
      - run:
          name: Deploy to Netlify (Auto Create Site)
          command: |
            echo "ðŸš€ Deploying to Netlify..."

            npx netlify deploy \
              --auth=$NETLIFY_AUTH_TOKEN \
              --dir=".next" \
              --prod \
              --json \
              --message="CI Deploy for user << parameters.user_id >>" \
              --create-site="user-<< parameters.user_id >>-site" \
              > deploy_output.json

            echo "Deploy Output:"
            cat deploy_output.json

      # Save artifacts
      - store_artifacts:
          path: deploy_output.json
          destination: deploy_output

workflows:
  version: 2
  deploy_workflow:
    jobs:
      - build_and_deploy:
          user_id: << pipeline.parameters.user_id >>
